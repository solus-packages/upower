From ae2f8b85969b023aa280d66dd9c3b3504d76ea9f Mon Sep 17 00:00:00 2001
From: Ikey Doherty <ikey@solus-project.com>
Date: Sun, 10 Dec 2017 14:19:32 +0000
Subject: [PATCH] Support a fully stateless configuration

Signed-off-by: Ikey Doherty <ikey@solus-project.com>
---
 etc/Makefile.am | 2 +-
 src/Makefile.am | 2 +-
 src/up-config.c | 7 ++++++-
 3 files changed, 8 insertions(+), 3 deletions(-)

diff --git a/etc/Makefile.am b/etc/Makefile.am
index 94d5548..7c7ad16 100644
--- a/etc/Makefile.am
+++ b/etc/Makefile.am
@@ -1,4 +1,4 @@
-configdir = $(sysconfdir)/UPower
+configdir = $(datadir)/UPower
 config_DATA = UPower.conf
 
 EXTRA_DIST =						\
diff --git a/src/Makefile.am b/src/Makefile.am
index 17fdb8a..2c913f7 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -162,7 +162,7 @@ dbusservice_DATA     = $(dbusservice_in_files:.service.in=.service)
 $(dbusservice_DATA): $(dbusservice_in_files) Makefile
 	@sed -e "s|\@libexecdir\@|$(libexecdir)|" $< > $@
 
-dbusconfdir = $(sysconfdir)/dbus-1/system.d
+dbusconfdir = $(datadir)/dbus-1/system.d
 dbusconf_in_files = org.freedesktop.UPower.conf.in
 dbusconf_DATA = $(dbusconf_in_files:.conf.in=.conf)
 
diff --git a/src/up-config.c b/src/up-config.c
index 2a17f30..8be2af1 100644
--- a/src/up-config.c
+++ b/src/up-config.c
@@ -105,8 +105,13 @@ up_config_init (UpConfig *config)
 	config->priv->keyfile = g_key_file_new ();
 
 	filename = g_strdup (g_getenv ("UPOWER_CONF_FILE_NAME"));
-	if (filename == NULL)
+	if (filename == NULL) {
 		filename = g_build_filename (PACKAGE_SYSCONF_DIR,"UPower", "UPower.conf", NULL);
+        if (!g_file_test(filename, G_FILE_TEST_EXISTS)) {
+			g_free(filename);
+			filename = g_build_filename (PACKAGE_DATA_DIR, "UPower", "UPower.conf", NULL);
+		}
+	}
 
 	/* load */
 	ret = g_key_file_load_from_file (config->priv->keyfile,
-- 
2.15.1

